<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Matrix setup with Synapse, Postgres, Maubot, and matrix-registration</title>
<meta http-equiv=onion-location content="http://kylrthjj7mpvktolz7u6fnudt3hpdvjw4hzquanjpepgsf5vcq5divad.onion/post/matrix-setup/"><meta property="og:title" content="Matrix setup with Synapse, Postgres, Maubot, and matrix-registration"><meta name=twitter:title content="Matrix setup with Synapse, Postgres, Maubot, and matrix-registration"><meta name=author content="Kyle Roth"><meta property="og:site_name" content="Kyle Roth"><meta property="og:url" content="https://kylrth.com/post/matrix-setup/"><meta name=twitter:card content="summary"><meta property="og:type" content="article"><meta name=generator content="Hugo 0.146.5"><link rel=stylesheet href=/css/style.min.css><script type=text/javascript src=/js/bundle.js></script></head><body><a href=#main class="skip-link p-screen-reader-text">Skip to content</a><svg style="display:none" aria-hidden="true"><symbol id="icon-permalink" viewBox="0 0 24 24"><g><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></g></symbol><symbol id="icon-feed" viewBox="0 0 16 16"><g><path d="M2.13 11.733c-1.175.0-2.13.958-2.13 2.126.0 1.174.955 2.122 2.13 2.122a2.126 2.126.0 002.133-2.122A2.133 2.133.0 002.13 11.733zM.002 5.436v3.067c1.997.0 3.874.781 5.288 2.196a7.45 7.45.0 012.192 5.302h3.08c0-5.825-4.739-10.564-10.56-10.564zM.006.0v3.068C7.128 3.068 12.924 8.87 12.924 16H16C16 7.18 8.824.0.006.0z"/></g></symbol><symbol id="icon-github" viewBox="0 0 16 16"><g><path d="M8 .198A8 8 0 005.471 15.789c.4.074.547-.174.547-.385.0-.191-.008-.821-.011-1.489-2.226.484-2.695-.944-2.695-.944-.364-.925-.888-1.171-.888-1.171-.726-.497.055-.486.055-.486.803.056 1.226.824 1.226.824.714 1.223 1.872.869 2.328.665.072-.517.279-.87.508-1.07-1.777-.202-3.645-.888-3.645-3.954.0-.873.313-1.587.824-2.147-.083-.202-.357-1.015.077-2.117.0.0.672-.215 2.201.82A7.672 7.672.0 018 4.066c.68.003 1.365.092 2.004.269 1.527-1.035 2.198-.82 2.198-.82.435 1.102.162 1.916.079 2.117.513.56.823 1.274.823 2.147.0 3.073-1.872 3.749-3.653 3.947.287.248.543.735.543 1.481.0 1.07-.009 1.932-.009 2.195.0.213.144.462.55.384A8 8 0 008.001.196z"/></g></symbol><symbol id="icon-gitlab" viewBox="0 0 28 28"><g><path d="M1.625 11.031 14 26.89.437 17.046a1.092 1.092.0 01-.391-1.203l1.578-4.813zm7.219.0h10.313L14.001 26.89zM5.75 1.469l3.094 9.562H1.625l3.094-9.562a.548.548.0 011.031.0zm20.625 9.562 1.578 4.813a1.09 1.09.0 01-.391 1.203l-13.563 9.844 12.375-15.859zm0 0h-7.219l3.094-9.562a.548.548.0 011.031.0z"/></g></symbol><symbol id="icon-instagram" viewBox="0 0 22 22"><g><path d="M15.445.0H6.554A6.559 6.559.0 000 6.554v8.891A6.559 6.559.0 006.554 22h8.891a6.56 6.56.0 006.554-6.555V6.554A6.557 6.557.0 0015.445.0zm4.342 15.445a4.343 4.343.0 01-4.342 4.342H6.554a4.341 4.341.0 01-4.341-4.342V6.554a4.34 4.34.0 014.341-4.341h8.891a4.342 4.342.0 014.341 4.341l.001 8.891z"/><path d="M11 5.312A5.693 5.693.0 005.312 11 5.694 5.694.0 0011 16.688 5.694 5.694.0 0016.688 11 5.693 5.693.0 0011 5.312zm0 9.163a3.475 3.475.0 11-.001-6.95 3.475 3.475.0 01.001 6.95zm5.7-10.484a1.363 1.363.0 11-1.364 1.364c0-.752.51-1.364 1.364-1.364z"/></g></symbol><symbol id="icon-linkedin" viewBox="0 0 16 16"><g><path d="M6 6h2.767v1.418h.04C9.192 6.727 10.134 6 11.539 6 14.46 6 15 7.818 15 10.183V15h-2.885v-4.27c0-1.018-.021-2.329-1.5-2.329-1.502.0-1.732 1.109-1.732 2.255V15H6V6zM1 6h3v9H1V6zM4 3.5A1.5 1.5.0 11.999 3.499 1.5 1.5.0 014 3.5z"/></g></symbol><symbol id="icon-medium" viewBox="0 0 24 24"><g><path d="M22.085 4.733 24 2.901V2.5h-6.634l-4.728 11.768L7.259 2.5H.303v.401L2.54 5.594c.218.199.332.49.303.783V16.96c.069.381-.055.773-.323 1.05L0 21.064v.396h7.145v-.401l-2.52-3.049a1.244 1.244.0 01-.347-1.05V7.806l6.272 13.659h.729l5.393-13.659v10.881c0 .287.0.346-.188.534l-1.94 1.877v.402h9.412v-.401l-1.87-1.831a.556.556.0 01-.214-.534V5.267a.554.554.0 01.213-.534z"/></g></symbol><symbol id="icon-npm" viewBox="0 0 16 16"><g><path d="M0 0v16h16V0H0zm13 13h-2V5H8v8H3V3h10v10z"/></g></symbol><symbol id="icon-twitter" viewBox="0 0 16 16"><g><path d="M16 3.538a6.461 6.461.0 01-1.884.516 3.301 3.301.0 001.444-1.816 6.607 6.607.0 01-2.084.797 3.28 3.28.0 00-2.397-1.034A3.28 3.28.0 007.882 6.029 9.321 9.321.0 011.116 2.598a3.284 3.284.0 001.015 4.381A3.301 3.301.0 01.643 6.57v.041A3.283 3.283.0 003.277 9.83a3.291 3.291.0 01-1.485.057 3.293 3.293.0 003.066 2.281 6.586 6.586.0 01-4.862 1.359 9.286 9.286.0 005.034 1.475c6.037.0 9.341-5.003 9.341-9.341.0-.144-.003-.284-.009-.425a6.59 6.59.0 001.637-1.697z"/></g></symbol><symbol id="icon-vimeo" viewBox="0 0 16 16"><g><path d="M15.994 4.281c-.072 1.556-1.159 3.691-3.263 6.397-2.175 2.825-4.016 4.241-5.522 4.241-.931.0-1.722-.859-2.366-2.581-.431-1.578-.859-3.156-1.291-4.734-.478-1.722-.991-2.581-1.541-2.581-.119.0-.538.253-1.256.753l-.753-.969c.791-.694 1.569-1.388 2.334-2.081 1.053-.909 1.844-1.387 2.372-1.438 1.244-.119 2.013.731 2.3 2.553.309 1.966.525 3.188.647 3.666.359 1.631.753 2.447 1.184 2.447.334.0.838-.528 1.509-1.588.669-1.056 1.028-1.862 1.078-2.416.097-.912-.262-1.372-1.078-1.372a2.98 2.98.0 00-1.184.263c.787-2.575 2.287-3.825 4.506-3.753 1.641.044 2.416 1.109 2.322 3.194z"/></g></symbol><symbol id="icon-wordpress" viewBox="0 0 16 16"><g><path d="M2 8c0 2.313 1.38 4.312 3.382 5.259L2.52 5.622A5.693 5.693.0 002 8zm10.05-.295c0-.722-.266-1.222-.495-1.612-.304-.482-.589-.889-.589-1.371.0-.537.418-1.037 1.008-1.037.027.0.052.003.078.005A6.064 6.064.0 008 2.156 6.036 6.036.0 002.987 4.79c.141.004.274.007.386.007.627.0 1.599-.074 1.599-.074.323-.018.361.444.038.482.0.0-.325.037-.687.055l2.185 6.33 1.313-3.835-.935-2.495a12.304 12.304.0 01-.629-.055c-.323-.019-.285-.5.038-.482.0.0.991.074 1.58.074.627.0 1.599-.074 1.599-.074.323-.018.362.444.038.482.0.0-.326.037-.687.055l2.168 6.282.599-1.947c.259-.809.457-1.389.457-1.889zm-3.945.806-1.8 5.095a6.148 6.148.0 003.687-.093.52.52.0 01-.043-.081L8.105 8.511zm5.16-3.315c.026.186.04.386.04.601.0.593-.114 1.259-.456 2.093l-1.833 5.16c1.784-1.013 2.983-2.895 2.983-5.051a5.697 5.697.0 00-.735-2.803zM8 0a8 8 0 100 16A8 8 0 008 0zm0 15A7 7 0 118 1a7 7 0 010 14z"/></g></symbol><symbol id="icon-youtube" viewBox="0 0 16 16"><g><path d="M15.841 4.8s-.156-1.103-.637-1.587c-.609-.637-1.291-.641-1.603-.678-2.237-.163-5.597-.163-5.597-.163h-.006s-3.359.0-5.597.163c-.313.038-.994.041-1.603.678C.317 3.697.164 4.8.164 4.8S.005 6.094.005 7.391v1.213c0 1.294.159 2.591.159 2.591s.156 1.103.634 1.588c.609.637 1.409.616 1.766.684 1.281.122 5.441.159 5.441.159s3.363-.006 5.6-.166c.313-.037.994-.041 1.603-.678.481-.484.637-1.588.637-1.588s.159-1.294.159-2.591V7.39c-.003-1.294-.162-2.591-.162-2.591zm-9.494 5.275V5.578l4.322 2.256-4.322 2.241z"/></g></symbol><symbol id="icon-matrix" viewBox="0 0 28 28"><g><path d="M.975097.640961V27.359H2.89517V28H.238281V0H2.89517V.640961H.975097z"/><path d="M8.37266 9.11071V10.4628H8.4111C8.7712 9.94812 9.20494 9.54849 9.71306 9.26518 10.2208 8.98235 10.8029 8.84036 11.4586 8.84036 12.0885 8.84036 12.664 8.96298 13.1846 9.2074c.5208.24483.9163.67596 1.1864 1.2941C14.6665 10.0638 15.0683 9.67744 15.5764 9.34266 16.0842 9.00804 16.6852 8.84036 17.3797 8.84036 17.9069 8.84036 18.3953 8.90487 18.8457 9.03365c.4498.128769999999999.8355.33478 1.157.61801C20.3239 9.93515 20.5746 10.3053 20.755 10.7621c.1799.4575.27 1.0077.27 1.6518v6.6827H18.2861V13.4373C18.2861 13.1027 18.2734 12.7872 18.2475 12.4908 18.2216 12.1949 18.1512 11.9375 18.0354 11.7183 17.9196 11.4996 17.7491 11.3256 17.5243 11.1967 17.2993 11.0684 16.9938 11.0037 16.6081 11.0037c-.3856.0-.6975.0745000000000005-.9354.222C15.4346 11.374 15.2483 11.5673 15.1134 11.8052c-.135.2386-.225.508800000000001-.2699.8116C14.7982 12.9192 14.7759 13.2252 14.7759 13.5342v5.5624H12.0372V13.4955C12.0372 13.1994 12.0305 12.9063 12.0181 12.6168 12.005 12.3269 11.9506 12.0598 11.8539 11.815 11.7575 11.5706 11.5967 11.374 11.3717 11.2257 11.1467 11.0782 10.8156 11.0037 10.3785 11.0037 10.2497 11.0037 10.0794 11.0327 9.86746 11.0908 9.65528 11.1487 9.44941 11.2584 9.25027 11.4191 9.05071 11.5802 8.88053 11.812 8.73908 12.1143 8.59754 12.4171 8.5269 12.8128 8.5269 13.3021v5.7945H5.78833V9.11071H8.37266z"/><path d="M26.0246 27.359V.640961h-1.92V0h2.657V28h-2.657V27.359h1.92z"/></g></symbol></svg><header class=l-header><p class="c-title p-title"><a href=/ class=p-title__link>Kyl<span style=color:gray>e</span> R<span style=color:gray>o</span>th</a></p></header><main id=main class=l-main><article class=p-article><header><h1>Matrix setup with Synapse, Postgres, Maubot, and matrix-registration</h1><div><div class=c-time>Posted on
<time datetime=2021-08-02T10:30:00-06:00>2021-08-02 at 10:30:00 UTC-0600</time></div><a href=/tags/self-hosted/ class=c-tag>self-hosted</a>
<a href=/tags/matrix/ class=c-tag>matrix</a></div></header><section id=js-article class=p-article__body><p>This is how I set up my own <a href=https://matrix.org>Matrix</a> server with Docker.<span class=sidenote-number><small class=sidenote>These instructions were originally for ARM, back when I ran this server on a Raspberry Pi. Unfortunately, the Matrix community stopped releasing ARM images, so the latest version that will work on ARM without QEMU is v1.26.0, which is very old now. These instructions have been updated to use <code>amd64</code> images, but I&rsquo;ll preserve the references to ARM images as comments. If you&rsquo;re going to work from a Pi, be sure to switch it to run in 64-bit mode for optimal performance: <code>echo 'arm_64bit=1' | sudo tee -a /boot/config.txt && sudo systemctl reboot</code>.</small></span>
There is an <a href=https://github.com/spantaleev/matrix-docker-ansible-deploy>Ansible playbook</a> that&rsquo;s quite popular, but I host a lot of other services with Docker on the same server and I wanted to continue managing all of them together, just with <code>docker-compose</code>.</p><p>This installation comes with <a href=https://github.com/maubot/maubot>Maubot</a> and <a href=https://github.com/ZerataX/matrix-registration>matrix-registration</a> containers too. If you don&rsquo;t want to use those features, leave out those sections of the docker-compose config and don&rsquo;t follow the instructions in the corresponding sections.</p><p>First create a directory for the services we&rsquo;re going to provide:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mkdir -p ~/services/data/<span style=color:#f92672>{</span>certbot,maubot,nginx,postgres,registration,synapse<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>cd ~/services
</span></span></code></pre></div><p>The rest of the commands below will assume the working directory is <code>~/services</code>.</p><h2 id=federation>federation <a class=header-link href=#federation><svg class="c-links__icon"><title>permalink</title><use xlink:href="#icon-permalink"/></svg></a></h2><p>The homeserver is going to be hosted on matrix.kylrth.com, but the server name is kylrth.com. (That way usernames can be <code>@kyle:kylrth.com</code> instead of <code>@kyle:matrix.kylrth.com</code>, which would be sort of like having an email address <code>kyle@email.kylrth.com</code>.) For federation to work correctly, other servers need to know that kylrth.com uses matrix.kylrth.com as its server. To do that, create the file <code>kylrth.com/.well-known/matrix/server</code> with the contents <code>{"m.server": "matrix.kylrth.com:443"}</code>, and the file <code>kylrth.com/.well-known/matrix/client</code> with <code>{"m.homeserver": {"base_url": "https://matrix.kylrth.com/"}}</code>.<span class=sidenote-number><small class=sidenote>You can also add a <code>support</code> file in that same directory, following my example <a href=https://kylrth.com/.well-known/matrix/support>here</a>.</small></span>
We should also add the following line to <code>/etc/hosts</code> so that any outgoing requests to matrix.kylrth.com are routed right back to the machine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>127.0.0.1 matrix.kylrth.com
</span></span></code></pre></div><p>Another note: you may want to change the DNS server to something better. I added the following line to <code>/etc/dhcpcd.conf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>static domain_name_servers=1.1.1.1 1.0.0.1 8.8.4.4 8.8.8.8
</span></span></code></pre></div><p>And then do <code>sudo service dhcpcd restart</code>.</p><h2 id=docker-compose>docker-compose <a class=header-link href=#docker-compose><svg class="c-links__icon"><title>permalink</title><use xlink:href="#icon-permalink"/></svg></a></h2><p>Now install <code>docker</code> and <code>docker-compose</code> following the instructions <a href=https://devdojo.com/bobbyiliev/how-to-install-docker-and-docker-compose-on-raspberry-pi>here</a>. Then create <code>docker-compose.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>wget /post/matrix-setup/docker-compose.yml
 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -O docker-compose.yml
</span></span></code></pre></div><p>You&rsquo;ll note that in several places I set the user to <code>1000:1000</code>. I did this so that data files are owned by my user, plus it&rsquo;s generally safer not to run containers as root. You can see which numbers you need to use by running <code>id -u</code> and <code>id -g</code>.</p><h2 id=ssl-certificate>SSL certificate <a class=header-link href=#ssl-certificate><svg class="c-links__icon"><title>permalink</title><use xlink:href="#icon-permalink"/></svg></a></h2><p>We&rsquo;re going to set up certbot with a new SSL certificate from LetsEncrypt. Since I host other things on this server besides matrix.kylrth.com, I do a wildcard certificate (<code>*.kylrth.com</code>), which requires DNS verification by creating a TXT record in the DNS settings for my domain.<span class=sidenote-number><small class=sidenote>You can use <code>host -t txt _acme-challenge.kylrth.com</code> to make sure the TXT records have been updated before having LetsEncrypt check them.</small></span></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mkdir -p data/certbot/conf
</span></span><span style=display:flex><span>curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot/certbot/ssl-dhparams.pem <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    &gt; data/certbot/conf/ssl-dhparams.pem
</span></span><span style=display:flex><span>curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    &gt; data/certbot/conf/options-ssl-nginx.conf
</span></span><span style=display:flex><span>docker-compose run --rm certbot certonly --manual --preferred-challenges<span style=color:#f92672>=</span>dns <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -w /var/www/certbot --email name@example.com -d <span style=color:#e6db74>&#39;*.kylrth.com&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --rsa-key-size <span style=color:#ae81ff>4096</span> --agree-tos --force-renewal
</span></span></code></pre></div><p>If you don&rsquo;t need a wildcard certificate, replace that last line with this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker-compose run --rm certbot certonly --webroot <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -w /var/www/certbot --email name@example.com -d <span style=color:#e6db74>&#39;matrix.kylrth.com&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --rsa-key-size <span style=color:#ae81ff>4096</span> --agree-tos --force-renewal
</span></span></code></pre></div><p>To renew the wildcard certificate, you&rsquo;ll have to run that last <code>docker-compose run certbot</code> line again. I&rsquo;d suggest creating a <code>scripts/</code> directory for things like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mkdir -p scripts
</span></span><span style=display:flex><span>wget /post/matrix-setup/scripts/update_cert.sh
 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -O scripts/update_cert.sh
</span></span><span style=display:flex><span>chmod +x scripts/update_cert.sh
</span></span></code></pre></div><p>If you want to set the certbot container to renew a <strong>non-wildcard</strong> certificate, remove the <code>profiles</code> section from the certbot container in the docker-compose.yml so that the container runs with the rest of the services, and add the following instead:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>entrypoint</span>: <span style=color:#e6db74>&#34;/bin/sh -c &#39;trap exit TERM; while :; do certbot renew; sleep 12h &amp; wait $${!}; done;&#39;&#34;</span>
</span></span></code></pre></div><p>Note that changing the entrypoint this way will break the previous <code>docker-compose run</code> command that you ran to get the certificate if you were to run it again.</p><h2 id=nginx>NGINX <a class=header-link href=#nginx><svg class="c-links__icon"><title>permalink</title><use xlink:href="#icon-permalink"/></svg></a></h2><p>To set up NGINX, download the <code>app.conf</code> I&rsquo;ve got <a href=/post/matrix-setup/app.conf>here</a> (and modify it to your liking):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>wget /post/matrix-setup/app.conf
 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -O data/nginx/app.conf
</span></span></code></pre></div><h2 id=synapse>Synapse <a class=header-link href=#synapse><svg class="c-links__icon"><title>permalink</title><use xlink:href="#icon-permalink"/></svg></a></h2><p>Before doing anything else, make sure you have the version you want in the docker-compose config for the Synapse container.<span class=sidenote-number><small class=sidenote>The last version to support ARM was v1.26.0, so if you&rsquo;re on ARM you&rsquo;ll need to use that.</small></span>
Update the docker-compose config to use whatever version is latest.<span class=sidenote-number><small class=sidenote>In general it&rsquo;s not a good idea to use the default <code>latest</code> tag for remote images, because version upgrades often require config updates. Always check the upgrade instructions for Synapse <a href=https://matrix-org.github.io/synapse/develop/upgrade>here</a>.</small></span></p><p>Now generate the initial configuration for Synapse:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker-compose run --rm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -e SYNAPSE_SERVER_NAME<span style=color:#f92672>=</span>kylrth.com -e SYNAPSE_REPORT_STATS<span style=color:#f92672>=</span>no <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    synapse generate
</span></span></code></pre></div><p>Now edit <code>data/synapse/homeserver.yaml</code> to your liking. Here are some things I did:</p><ul><li>change <code>max_upload_size</code> to <code>"100M"</code> or something</li><li>enable URL previews</li></ul><p>Run <code>docker-compose run -v /etc/passwd:/etc/passwd:ro postgres</code> to give Postgres the chance to initialize the database before Synapse looks for it.</p><p>The next thing you should do is create the first user for yourself, and make that user an admin on the server. Run <code>docker-compose up synapse</code> to start the container temporarily, then open another terminal and run <code>docker-compose exec synapse register_new_matrix_user -c /data/homeserver.yaml http://localhost:8008</code>. Don&rsquo;t forget to make yourself an admin! Once you finish with that command, quit the <code>up</code> process with Ctrl+C, and then run <code>docker-compose down</code> to destroy all the containers.</p><h2 id=maubot>Maubot <a class=header-link href=#maubot><svg class="c-links__icon"><title>permalink</title><use xlink:href="#icon-permalink"/></svg></a></h2><p>Generate a config file by running <code>docker-compose run --rm maubot</code> and then update the config to your liking, making sure to update the following objects:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>public_url</span>: <span style=color:#ae81ff>https://matrix.kylrth.com</span>
</span></span><span style=display:flex><span><span style=color:#f92672>registration_secrets</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>kylrth.com</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://matrix.kylrth.com</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>secret</span>: <span style=color:#ae81ff>&lt;registration secret from data/synapse/homeserver.yaml&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>admins</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>root</span>: <span style=color:#e6db74>&#39;&#39;</span>  <span style=color:#75715e># disable login</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;username&gt;</span>: <span style=color:#ae81ff>&lt;password&gt; </span> <span style=color:#75715e># password will be replaced with bcrypted hash on startup</span>
</span></span></code></pre></div><h2 id=matrix-registration>matrix-registration <a class=header-link href=#matrix-registration><svg class="c-links__icon"><title>permalink</title><use xlink:href="#icon-permalink"/></svg></a></h2><p>Copy the sample config from the repo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>wget https://raw.githubusercontent.com/ZerataX/matrix-registration/master/config.sample.yaml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -O data/registration/config.yaml
</span></span></code></pre></div><p>Update the config to your liking, making sure to update the following elements:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>server_location</span>: <span style=color:#e6db74>&#39;http://synapse&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>server_name</span>: <span style=color:#e6db74>&#39;kylrth.com&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>registration_shared_secret</span>: <span style=color:#ae81ff>&lt;registration secret from data/synapse/homeserver.yaml&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>admin_api_shared_secret</span>: <span style=color:#ae81ff>&lt;invent a secret string here&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>base_url</span>: <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>db</span>: <span style=color:#e6db74>&#39;sqlite:////data/db.sqlite3&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>host</span>: <span style=color:#e6db74>&#39;0.0.0.0&#39;</span>  <span style=color:#75715e># super important for running in Docker</span>
</span></span><span style=display:flex><span><span style=color:#f92672>logging</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>handlers</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>filename</span>: <span style=color:#ae81ff>/data/m_reg.log</span>
</span></span></code></pre></div><p>I&rsquo;ve got a script that can be used to create a one-time-use token that expires after 7 days:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mkdir -p scripts
</span></span><span style=display:flex><span>wget /post/matrix-setup/scripts/new_matrix_token.sh
 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -O scripts/new_matrix_token.sh
</span></span><span style=display:flex><span>chmod +x scripts/new_matrix_token.sh
</span></span></code></pre></div><p>Read about your options for managing tokens <a href=https://github.com/ZerataX/matrix-registration/wiki/api#creating-a-new-token>here</a>.</p><h2 id=enabling-the-services-with-systemd>enabling the services with Systemd <a class=header-link href=#enabling-the-services-with-systemd><svg class="c-links__icon"><title>permalink</title><use xlink:href="#icon-permalink"/></svg></a></h2><p>See <a href=/post/self-hosting/#systemd-and-docker>this section</a> of my self-hosting post to learn how to use Systemd to make this set of containers a background service that starts at boot. Now we&rsquo;re finally ready to get everything started.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo systemctl start services
</span></span></code></pre></div><p>Message me <a href=https://matrix.to/#/@kyle:kylrth.com>@kyle:kylrth.com</a> and tell me how it went!</p></section><footer><nav class="p-pagination c-pagination"><div class=c-pagination__ctrl><div class=c-pagination__newer><a href=/post/minecraft/>Newer</a></div><div class=c-pagination__older><a href=/post/latex-vscode/>Older</a></div></div></nav><section class=p-related><h3>See Also</h3><ul id=slider class=p-related__list><li class="p-related__item js-related__item"><a href=/post/matrix-registration/><span>using Matrix</span></a></li><li class="p-related__item js-related__item"><a href=/post/minecraft/><span>Minecraft in Docker</span></a></li><li class="p-related__item js-related__item"><a href=/post/avatarify/><span>avatarify</span></a></li><li class="p-related__item js-related__item"><a href=/post/self-hosting/><span>hosting my own web services</span></a></li><li class="p-related__item js-related__item"><a href=/post/jupyter-lab/><span>Jupyter Lab Hub in Docker with Nvidia GPU support</span></a></li><li class="p-related__item js-related__item"><a href=/post/latex-vscode/><span>I really just want to edit and compile my LaTeX files in VS Code</span></a></li></ul></section></footer></article></main><nav class="l-nav p-menu"><ul class=p-menu__lists><li class=p-menu__listitem><a href=/>homepage</a></li><li class=p-menu__listitem><a href=/post/>posts</a></li><li class=p-menu__listitem><a href=/paper/>paper notes</a></li><li class=p-menu__listitem><a href=/book/>book notes</a></li></ul></nav><footer class=l-footer><ul class=c-links><li class=c-links__item><a href=https://matrix.to/#/%40kyle%3akylrth.com target=_blank><svg viewBox="0 0 30 28" class="c-links__icon"><title>matrix</title><use xlink:href="#icon-matrix"/></svg></a></li><li class=c-links__item><a href=https://github.com/kylrth target=_blank><svg viewBox="0 0 64 64" class="c-links__icon"><title>github</title><use xlink:href="#icon-github"/></svg></a></li><li class=c-links__item><a href=https://www.linkedin.com/in/kyle-roth/ target=_blank><svg viewBox="0 0 64 64" class="c-links__icon"><title>linkedin</title><use xlink:href="#icon-linkedin"/></svg></a></li></ul><p class=p-copyright><a href=https://github.com/kylrth/kylrth.github.io/commits/9d7aea704be38ca2990319671542ae7ce3c0459a/content/post/matrix-setup/index.md>page
history</a></p></footer></body></html>